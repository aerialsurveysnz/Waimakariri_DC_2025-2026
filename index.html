<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Mapbox GeoJSON Layer</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id='map'></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiamFtZXMtbWNrZW56aWUtYXNsIiwiYSI6ImNsaHBtYXo1aDA4MWczZ281bXJhbnc0dGMifQ.8pxJxAy6HV0CQfuibaIFmw';

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-streets-v12',
      center: [172.308,-43.2456,],
      zoom: 9
    });

    map.on('load', function () {
      // Add your sources and layers here...

      map.addSource('ProjectArea1', {
        type: 'geojson',
        data: 'Data/Waimakariri_DC_2025-2026 - Project_Area.geojson'
      });

      map.addLayer({
        id: 'ProjectLayer1',
        type: 'fill',
        source: 'ProjectArea1',
        paint: {
          'fill-color': 'Blue',
          'fill-opacity': 0.5
        }
      });

      map.addSource('CoverageSource1', {
        type: 'geojson',
        data: 'Data/Waimakariri_DC_2025-2026 - Captured_Area.geojson'
      });

      map.addLayer({
        id: 'CoverageLayer1',
        type: 'fill',
        source: 'CoverageSource1',
        paint: {
          'fill-color': '#FF0000',
          'fill-opacity': 0.5
        }
      });

      map.addSource('ProjectCentre1', {
        type: 'geojson',
        data: 'Data/Waimakariri_DC_2025-2026 - Imagery_Centres.geojson'
      });

      map.addLayer({
        id: 'PCentre1',
        type: 'circle',
        source: 'ProjectCentre1',
        paint: {
				'circle-radius': [
                                'interpolate',
                                ['exponential', 1.10],
                                ['zoom'],
                                0,
                                0.5,
                                19,
                                15
                                ],
                    'circle-color': 'white'
            }
      });
  // ðŸ”¹ Helper: always opens progress.html for hard-coded projectRef
  function openProgressPopup({ coordinates, descriptionHTML}) {
    const projectRef = "PGRM3268"; // <-- Hard-coded here
    
   // const fullContent = document.createElement('div');

// Outer container for popup
  const fullContent = document.createElement('div');
  fullContent.style.display = 'flex';
  fullContent.style.flexDirection = 'row';
  fullContent.style.gap = '10px';     // spacing between left and right
  fullContent.style.alignItems = 'flex-start';

  // Left column (description text)
  const desc = document.createElement('div');
  desc.innerHTML = descriptionHTML;
  desc.style.maxWidth = '300px';   // keep it tidy
  fullContent.appendChild(desc);

    const frame = document.createElement('iframe');
    frame.src = 'progress.html?ref=' + encodeURIComponent(projectRef) + '&t=' + Date.now();
    frame.style.width = '600px';
    frame.style.height = '240px';
    frame.style.border = '0';
    fullContent.appendChild(frame);

    const popup = new mapboxgl.Popup({ closeOnClick: true, maxWidth: '800px'})
      .setLngLat(coordinates)
      .setDOMContent(fullContent)
      .addTo(map);

    popup.on('close', () => {
      try { frame.src = 'about:blank'; } catch {}
      frame.remove();
    });
  }

  // ðŸ”¹ Click handler
  map.on('click', function (e) {
 const featuresPCentre  = map.queryRenderedFeatures({ layers: ['PCentre1'] });
  const featuresCoverage = map.queryRenderedFeatures({ layers: ['CoverageLayer1'] });
  const featuresProject  = map.queryRenderedFeatures({ layers: ['ProjectLayer1'] });

    if (featuresPCentre.length > 0 && featuresProject.length > 0) {
      const featurePCentre = featuresPCentre[0];
      const featureCoverage = featuresCoverage[0];

      const coordinates = featurePCentre.geometry.coordinates.slice();


      const description =
        "<span style='color:#7FBA00;font-size:14px;'><b>" + featurePCentre.properties.Proj_Name + "</b></span><br>" +
         "<span style='color: black;'><b>Project Code: </b>" + featurePCentre.properties.Project + "</br>" +
        "<b>Survey Type: </b>" + featurePCentre.properties.Survey_Typ + "<br>" +
        "<b>Sun Angle: </b> 35 Degrees<br>" +
        "<b>Imagery GSD: </b>" + featurePCentre.properties.OrthoGSD_m + "<br>" +
        "<b>Area: </b>" + (featurePCentre.properties.Area).toLocaleString() + " kmÂ²<br>" +
        "<b>Captured Area: </b>" + (featureCoverage.properties.Area).toLocaleString() + " kmÂ²<br>" +
        "<b>Coverage To Date: </b>" + featureCoverage.properties.Percentage_Coverage + "%<br>";

      openProgressPopup({ coordinates, descriptionHTML: description });
    }
  });

  // ðŸ”¹ Cursor feedback
  map.on('mouseenter', 'PCentre4', () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'PCentre4', () => { map.getCanvas().style.cursor = ''; });
});

  </script>
</body>
</html>
